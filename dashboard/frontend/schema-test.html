<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Error Fix Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: #ffffff;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #2d5016; border-left: 4px solid #4caf50; }
        .error { background: #5d1616; border-left: 4px solid #f44336; }
        .warning { background: #5d4e16; border-left: 4px solid #ff9800; }
        #logs {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error-log { color: #ff6b6b; }
        .warn-log { color: #ffa500; }
    </style>
</head>
<body>
    <h1>TradingView Schema Error Fix Verification</h1>
    
    <div id="result" class="status warning">
        <h3>‚è≥ Testing in progress...</h3>
        <p>Monitoring console for schema errors...</p>
    </div>
    
    <div>
        <h3>Live Console Output:</h3>
        <div id="logs"></div>
    </div>

    <script>
        const resultDiv = document.getElementById('result');
        const logsDiv = document.getElementById('logs');
        
        let schemaErrorCount = 0;
        let totalErrorCount = 0;
        let warningCount = 0;
        
        // Capture all console output
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const logEntry = document.createElement('div');
            logEntry.className = type + '-log';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Check for the specific schema error
            if (message.includes('unknown does not match a schema') || 
                message.includes('data type: unknown') ||
                message.includes('Property:The state with a data type: unknown')) {
                schemaErrorCount++;
                updateResult();
            }
        }
        
        console.error = function(...args) {
            const message = args.join(' ');
            originalError.apply(console, args);
            totalErrorCount++;
            addLog(message, 'error');
            updateResult();
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            originalWarn.apply(console, args);
            warningCount++;
            addLog(message, 'warn');
        };
        
        console.log = function(...args) {
            const message = args.join(' ');
            originalLog.apply(console, args);
            addLog(message, 'log');
        };
        
        function updateResult() {
            if (schemaErrorCount > 0) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Schema errors still occurring: ${schemaErrorCount}</h3>
                    <p>The fix needs additional work. Found ${totalErrorCount} total errors, ${warningCount} warnings.</p>
                `;
            } else if (totalErrorCount > 0) {
                resultDiv.className = 'status warning';
                resultDiv.innerHTML = `
                    <h3>‚ö†Ô∏è No schema errors, but other errors present: ${totalErrorCount}</h3>
                    <p>Schema validation is working! Found ${warningCount} warnings.</p>
                `;
            } else {
                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <h3>‚úÖ Success! No schema errors detected!</h3>
                    <p>TradingView is loading cleanly. Found ${warningCount} warnings (normal).</p>
                `;
            }
        }
        
        // Load the main application by opening it in an iframe
        const iframe = document.createElement('iframe');
        iframe.src = 'http://localhost:3002/';
        iframe.style.width = '1px';
        iframe.style.height = '1px';
        iframe.style.position = 'absolute';
        iframe.style.left = '-9999px';
        iframe.style.border = 'none';
        
        iframe.onload = function() {
            addLog('Application loaded, monitoring for 15 seconds...');
            
            // Check results after 15 seconds
            setTimeout(() => {
                addLog('=== MONITORING COMPLETE ===');
                addLog(`Final Results: Schema Errors: ${schemaErrorCount}, Total Errors: ${totalErrorCount}, Warnings: ${warningCount}`);
                updateResult();
                
                if (schemaErrorCount === 0) {
                    addLog('üéâ SUCCESS: No "unknown data type" schema errors detected!');
                } else {
                    addLog('‚ùå FAILED: Schema errors still occurring');
                }
            }, 15000);
        };
        
        iframe.onerror = function() {
            addLog('Failed to load application', 'error');
            totalErrorCount++;
            updateResult();
        };
        
        document.body.appendChild(iframe);
        addLog('Starting schema error monitoring...');
    </script>
</body>
</html>