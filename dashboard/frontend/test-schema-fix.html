<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Schema Error Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: #ffffff;
        }
        
        #status {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success { background: #2d5016; border: 1px solid #4caf50; }
        .error { background: #5d1616; border: 1px solid #f44336; }
        .warning { background: #5d4e16; border: 1px solid #ff9800; }
        
        #chart-container {
            width: 100%;
            height: 600px;
            border: 1px solid #333;
            background: #1a1a1a;
        }
        
        #console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .error-line { color: #ff6b6b; }
        .warn-line { color: #ffa500; }
        .success-line { color: #4caf50; }
    </style>
</head>
<body>
    <h1>TradingView Schema Error Fix Test</h1>
    
    <div id="status" class="warning">
        <h3>Testing Status: Initializing...</h3>
        <p>Waiting for TradingView widget to load and checking for schema errors...</p>
    </div>
    
    <div id="chart-container"></div>
    
    <div id="console-output">
        <div>Console Output (monitoring for schema errors):</div>
        <div>==========================================</div>
    </div>

    <script type="module">
        // Import the TradingView class
        import { TradingViewManager } from './dist/assets/index-kQH2SbOx.js';

        const statusDiv = document.getElementById('status');
        const consoleOutput = document.getElementById('console-output');
        
        let errorCount = 0;
        let schemaErrorCount = 0;
        let warningCount = 0;
        
        // Capture console logs
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function addToConsole(message, type = 'log') {
            const div = document.createElement('div');
            div.className = type + '-line';
            div.textContent = new Date().toISOString() + ': ' + message;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Check for schema errors
            if (message.includes('unknown does not match a schema') || 
                message.includes('data type: unknown')) {
                schemaErrorCount++;
                updateStatus();
            }
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            warningCount++;
            addToConsole(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            errorCount++;
            addToConsole(args.join(' '), 'error');
        };
        
        function updateStatus() {
            if (schemaErrorCount > 0) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `
                    <h3>❌ Schema Errors Detected: ${schemaErrorCount}</h3>
                    <p>The TradingView schema validation fix needs more work.</p>
                `;
            } else if (errorCount > 0) {
                statusDiv.className = 'warning';
                statusDiv.innerHTML = `
                    <h3>⚠️ Other Errors: ${errorCount}, Warnings: ${warningCount}</h3>
                    <p>No schema errors detected! But there are other issues.</p>
                `;
            } else {
                statusDiv.className = 'success';
                statusDiv.innerHTML = `
                    <h3>✅ No Schema Errors Detected!</h3>
                    <p>TradingView widget loaded successfully without schema validation errors. Warnings: ${warningCount}</p>
                `;
            }
        }
        
        // Test the TradingView integration
        async function testTradingView() {
            try {
                console.log('Starting TradingView schema error fix test...');
                
                const config = {
                    container_id: 'chart-container',
                    symbol: 'BTC-USD',
                    interval: '1D',
                    library_path: 'https://unpkg.com/tradingview-charting-library@latest/',
                    debug: true,
                    fullscreen: false,
                    autosize: true,
                    studies_overrides: {},
                    overrides: {
                        "mainSeriesProperties.candleStyle.upColor": "#4caf50",
                        "mainSeriesProperties.candleStyle.downColor": "#f44336"
                    }
                };
                
                console.log('Creating TradingView manager with comprehensive schema validation...');
                const manager = new TradingViewManager(config);
                
                console.log('Initializing TradingView widget...');
                await manager.initialize();
                
                console.log('TradingView initialization completed');
                
                // Wait for chart to fully load and check for errors
                setTimeout(() => {
                    updateStatus();
                    
                    // Additional test: Try to trigger post-creation operations
                    console.log('Testing post-creation operations...');
                    if (manager.setSymbol) {
                        manager.setSymbol('ETH-USD');
                    }
                    if (manager.setInterval) {
                        manager.setInterval('4H');
                    }
                    
                    // Final status update after all operations
                    setTimeout(() => {
                        updateStatus();
                        console.log(`Final Test Results: Schema Errors: ${schemaErrorCount}, Other Errors: ${errorCount}, Warnings: ${warningCount}`);
                    }, 3000);
                }, 5000);
                
            } catch (error) {
                console.error('Test failed:', error);
                errorCount++;
                updateStatus();
            }
        }
        
        // Start the test
        testTradingView();
        
        // Monitor for errors for 30 seconds
        setTimeout(() => {
            console.log('=== TEST COMPLETED ===');
            console.log(`Final Results after 30 seconds:`);
            console.log(`- Schema Errors: ${schemaErrorCount}`);
            console.log(`- Other Errors: ${errorCount}`);
            console.log(`- Warnings: ${warningCount}`);
            updateStatus();
        }, 30000);
    </script>
</body>
</html>