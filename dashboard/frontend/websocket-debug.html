<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug Test</title>
</head>
<body>
    <h1>WebSocket Debug Test</h1>
    <div id="output"></div>
    <button onclick="testWebSocket()">Test WebSocket Connection</button>
    <button onclick="testWebSocketClass()">Test WebSocket Class</button>
    
    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += `<p>${new Date().toISOString()}: ${message}</p>`;
            console.log(message);
        }
        
        function testWebSocketClass() {
            log('Testing WebSocket class availability...');
            
            if (typeof WebSocket === 'undefined') {
                log('❌ WebSocket class is not available');
                return;
            }
            
            log('✅ WebSocket class is available');
            log(`WebSocket constructor: ${WebSocket.toString().substring(0, 100)}...`);
            
            // Check WebSocket ready states
            log(`WebSocket.CONNECTING: ${WebSocket.CONNECTING}`);
            log(`WebSocket.OPEN: ${WebSocket.OPEN}`);
            log(`WebSocket.CLOSING: ${WebSocket.CLOSING}`);
            log(`WebSocket.CLOSED: ${WebSocket.CLOSED}`);
        }
        
        function testWebSocket() {
            log('Starting WebSocket connection test...');
            
            if (typeof WebSocket === 'undefined') {
                log('❌ WebSocket not supported by this browser');
                return;
            }
            
            const wsUrl = 'ws://localhost:8000/ws';
            log(`Attempting to connect to: ${wsUrl}`);
            
            try {
                const ws = new WebSocket(wsUrl);
                log('✅ WebSocket object created successfully');
                log(`Initial ready state: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                
                ws.onopen = function(event) {
                    log('✅ WebSocket connection opened');
                    log(`Ready state: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                    
                    // Send a test message
                    ws.send('Hello from debug test');
                    log('📤 Sent test message');
                };
                
                ws.onmessage = function(event) {
                    log(`📥 Received message: ${event.data}`);
                };
                
                ws.onclose = function(event) {
                    log(`🔌 WebSocket closed - Code: ${event.code}, Reason: ${event.reason}, Was Clean: ${event.wasClean}`);
                    log(`Final ready state: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                };
                
                ws.onerror = function(error) {
                    log(`❌ WebSocket error occurred: ${error}`);
                    log(`Error ready state: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                    console.error('WebSocket error details:', error);
                };
                
                // Check ready state after a short delay
                setTimeout(() => {
                    log(`Ready state after 100ms: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                }, 100);
                
                setTimeout(() => {
                    log(`Ready state after 1s: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                }, 1000);
                
                setTimeout(() => {
                    log(`Ready state after 5s: ${ws.readyState} (${getReadyStateText(ws.readyState)})`);
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('🔌 Manually closing connection');
                    }
                }, 5000);
                
            } catch (error) {
                log(`❌ Failed to create WebSocket: ${error.message}`);
                console.error('WebSocket creation error:', error);
            }
        }
        
        function getReadyStateText(readyState) {
            switch(readyState) {
                case WebSocket.CONNECTING: return 'CONNECTING';
                case WebSocket.OPEN: return 'OPEN';
                case WebSocket.CLOSING: return 'CLOSING';
                case WebSocket.CLOSED: return 'CLOSED';
                default: return 'UNKNOWN';
            }
        }
        
        // Auto-run tests on load
        window.onload = function() {
            log('Page loaded, running automatic tests...');
            testWebSocketClass();
            setTimeout(() => {
                testWebSocket();
            }, 1000);
        };
    </script>
</body>
</html>